---
import Layout from "../layouts/Layout.astro";
import { getEntry } from "astro:content";
import Cart from "@components/Cart/index.astro";
import { getCart, getCartTotal } from "@lib/cart";
import { ENABLE_STOREFRONT } from "astro:env/server";

export const prerender = false;

if (!ENABLE_STOREFRONT) {
  return Astro.rewrite("/404");
}

const cart = getCart(Astro.cookies);
const cartContents = await Promise.all(
  cart.items.map(async (item) => {
    const entry = await getEntry("products", item.productId);
    if (!entry) {
      throw `Product ${item.productId} not found`;
    }

    return {
      ...item,
      product: entry.data,
    };
  })
);
const cartTotal = getCartTotal(cart);
---

<Layout
  title="Gör ändringar i din kundvagn"
  metaDescription="Produkter i din kundvagn"
>
  <Cart contents={cartContents} total={cartTotal} />
</Layout>
