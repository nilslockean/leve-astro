---
import Layout from "../../layouts/Layout.astro";
import { getEntry } from "astro:content";
import ProductDetail from "@components/ProductDetail/index.astro";
import { sanityAPI } from "@lib/sanityAPI";
import {
  PICKUP_DATE_MIN_OFFSET,
  PICKUP_DATE_MAX_OFFSET,
  ENABLE_STOREFRONT,
} from "astro:env/server";
import { getDateString, addDays, isDateInFuture } from "@lib/dateUtils";

export const prerender = false;

if (!ENABLE_STOREFRONT) {
  return Astro.rewrite("/404");
}

const { id = "" } = Astro.params;
const entry = await getEntry("products", id);

if (!entry) {
  return Astro.rewrite("/404");
}

const pickupDateMin = addDays(PICKUP_DATE_MIN_OFFSET);
const pickupDateMax = addDays(PICKUP_DATE_MAX_OFFSET);

const defaultPickupDates = await sanityAPI.getOpenDaysInRange(
  getDateString(pickupDateMin),
  getDateString(pickupDateMax)
);

const availablePickupDates = entry.data.pickupDates?.length
  ? entry.data.pickupDates.filter((dateStr) => isDateInFuture(dateStr))
  : defaultPickupDates;
---

<Layout
  title={entry.data.title}
  metaDescription="Beställ dina fredagsmunkar i förväg och hämta enkelt upp vid vald tid."
>
  <ProductDetail product={entry.data} {availablePickupDates} />
</Layout>
